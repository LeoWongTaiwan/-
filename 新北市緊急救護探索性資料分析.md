#分析背景

##分析目標
希望藉由敘述統計及圖像化方式，在2007年至2012年之68萬餘筆資料中，試圖看出一些脈絡及後續值得探討的議題

##分析架構
主要使用R語言及各種套件製圖，並加入相關人口變數(如各區人口總數、及男女比例等)，同時以既有資料製作衍生性欄位(如到達現場時間、年齡分群、及地理位置GIS欄位等)

##資料清理
除了案件編號、進號時間、到達現場時間、回勤時間等欄位具備完整資料，其他欄位都有許多空值，也有許多欄位有明顯人為輸入錯誤，因此依照不同情況，在分析時會將不包含部分資料，並會附註

![Column names](https://github.com/LeoWongTaiwan/Research-Project/blob/master/%E8%B3%87%E6%96%99%E6%AC%84%E4%BD%8D%20-%20%E5%9F%BA%E6%9C%AC%E8%B3%87%E6%96%99.png)

![Column names](https://github.com/LeoWongTaiwan/Research-Project/blob/master/%E8%A1%8D%E7%94%9F%E6%80%A7%E8%B3%87%E6%96%99.png)

![Column names](https://github.com/LeoWongTaiwan/Research-Project/blob/master/%E4%BA%BA%E5%8F%A3%E8%B3%87%E6%96%99.png)

![Data cleaning process](https://github.com/LeoWongTaiwan/Research-Project/blob/master/Data%20cleaning%20process.png)

清理流程
```
#檢查Data是否有缺陷
NTP_Data <- ntp %>%
  mutate(cut_time = as.integer(substr(出勤通知時間, 12, 13))) %>%
  mutate(cht_time = factor(cut(cut_time, c(0,1,3,5,7,9,11,13,15,17,19,21,23,24), c("子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥","子"),right=FALSE))) %>%
  mutate(district = substr(發生地點,4,6)) %>%
  #filter(complete.cases(zip_x,zip_y)) %>%
  mutate(mm=as.integer(strftime(format(出勤通知時間, "%Y-%m-%d"),"%m")), response_min=response/60) %>%
  mutate(yy=as.integer(strftime(format(出勤通知時間, "%Y-%m-%d"),"%Y"))) %>%
  mutate(GIS_X = ifelse(is.na(tgos_x), zip_x, tgos_x)) %>% # 如果tgos_x is NA then GIS_X = zip_X
  mutate(GIS_Y = ifelse(is.na(tgos_y), zip_y, tgos_y)) %>%
  filter(complete.cases(GIS_X, GIS_Y)) %>%
  select(yy,mm,
         call_time=出勤通知時間,arr_time=到達現場時間,
         response,hos_arr=送達醫院時間,hos_leave=離開醫院時間,back_time=返隊待命時間,
         cut_time,cht_time,
         station_id=出勤單位,address=發生地點,
         district,hostpital=送達醫院名稱,
         sex=患者性別,age=患者年齡,call_reason=求救原因,patient_reason=病患主訴,response_min,
         zip_x,zip_y,tgos_x,tgos_y,GIS_X,GIS_Y,
         undo_duty=空跑原因,medical_history=過去病史紀錄,treatment=急救處置,life_signs=生命徵象紀錄,OHCA_reason=到院前死亡可能原因)

#拿掉一些row
NTP_Data <-  subset(NTP_Data,select=-c(20:23)) #地理位置前四個拿掉
sum(NTP_Data$yy=='2003') #2003只有一組資料，很奇怪
sum(NTP_Data$yy=='2013') #2013只有1639組資料，很奇怪
NTP_Data <- subset(NTP_Data,yy!="2003")
NTP_Data <- subset(NTP_Data,yy!="2013")
NTP_Data$district <- as.factor(NTP_Data$district)
NTP_Data[NTP_Data$age == 9999 & is.na(NTP_Data$age)==F,16] <- NA #把年齡9999的設成NA

#-------------------------開放資料庫-------------------------------
#匯入人口變數,各年12月資料(新北市政府資料庫)
population_2007 <- read.csv("2007_population.csv",header=T,sep=",")
population_2008 <- read.csv("2008_population.csv",header=T,sep=",")
population_2009 <- read.csv("2009_population.csv",header=T,sep=",")
population_2010 <- read.csv("2010_population.csv",header=T,sep=",")
population_2011 <- read.csv("2011_population.csv",header=T,sep=",")
population_2012 <- read.csv("2012_population.csv",header=T,sep=",")
population_2013 <- read.csv("2013_population.csv",header=T,sep=",")
rm(population_2007,population_2008,population_2009,population_2010,population_2011,population_2012,population_2013)

#合併以上資料
pop_2007_to_2013 <- rbind(population_2007,population_2008,population_2009,population_2010,population_2011,population_2012,population_2013)
pop_2007_to_2013$district <- as.character(pop_2007_to_2013$district)

#加入NTP_Test測試
colnames(pop_2007_to_2013)[1] <- "vil_num"
colnames(pop_2007_to_2013)[2] <- "neighbor_num"
colnames(pop_2007_to_2013)[3] <- "household_num"
colnames(pop_2007_to_2013)[4] <- "male_num"
colnames(pop_2007_to_2013)[5] <- "female_num"
colnames(pop_2007_to_2013)[6] <- "yy"
colnames(pop_2007_to_2013)[7] <- "district"
colnames(pop_2007_to_2013)
colnames(NTP_Test)

#合併NTP_Data
NTP_Data_V2 <- full_join(NTP_Data, pop_2007_to_2013, by = c("yy"="yy","district"="district"))
head(NTP_Data_V2,10)
NTP_Data_V2 <- NTP_Data_V2[-c(687303:687337),]

head(NTP_Data_V2[,c("district","neighbor_num","male_num")],10)
#檢查Call Reason
#檢查醫院是na的欄位，call reason是那些

levels_callreason <- levels(NTP_Data_V2$call_reason)
NTP_HospitalNA <- NTP_Data_V2[is.na(NTP_Data_V2$hostpital),]

c <- list()
for(i in 1:34){
  c[[i]] <- lengths(NTP_HospitalNA[NTP_HospitalNA$call_reason==levels_callreason[i]
                                   &is.na(NTP_HospitalNA$call_reason)==F,])[[1]]
}

HospitalNA_Callreason <- Reduce(c,c) #把list裡的component併成一個
HospitalNA_Callreason[35] <- nrow(NTP_HospitalNA)-sum(HospitalNA_Callreason)
levels_callreason[35] <- "NA"
names(HospitalNA_Callreason) <- levels_callreason #命名
HospitalNA_Callreason #這裡是所有醫院未知的案例的call reason

```
#總案件數量分析
##新北市六年總案件數量依各區分類
可將各地區分為高、中、低案件量區，如下：
1. 高案件量區(超過6萬件，平均每年超過1萬件)：中和區(95,209)、新店區(71,409)、三重區(69,006)、板橋區(68,408)
2. 中案件量區(超過3萬件，平均每年超過5千件)：永和區(47,731)、土城區(46,661)、樹林區(40,332)、蘆洲區(35,658)
3. 低案件量區(低於3萬件，平均每年低於5千件)：其餘地區

![Data cleaning process](https://github.com/LeoWongTaiwan/Research-Project/blob/master/%E5%90%84%E5%9C%B0%E5%8D%80%E6%A1%88%E4%BB%B6%E6%95%B8%E9%87%8F.png)

```
#看各地區各年累計報案數量
barplot(table(NTP_Data_V3$district),
        main="Distrinct Distibution",
        xlab="Distrinct",
        ylab="Counts",
        cex.names=1,
        las=2)
```

##各時間區間之案件量分布
發現在卯時(5~7點)至辰時(7~9點)間有巨大差異，原因可能來自上班交通時間較容易發生交通事故等，但過了辰時後直至亥時，總案件數量都沒有掉下來，因此接下來將研究各時間區間之報案原因分布

![各時間區間之案件量分布](https://github.com/LeoWongTaiwan/Research-Project/blob/master/%E5%90%84%E6%99%82%E8%BE%B0%E5%A0%B1%E6%A1%88%E6%95%B8%E9%87%8F.png)

```
#計算cut time分布
levels(NTP_Data_V2$cht_time)

ggplot(NTP_Data_V3,aes(cht_time))+
  geom_bar(position="identity",stat = "count")+
  geom_line(position="identity",stat = "count",color="#F8766D",size=2)+
  theme(plot.title = element_text(family="BL",size=20, face="bold",hjust=0.4),
        axis.text.x=element_text(hjust=1,vjust=0.5,family="BL"),
        axis.text=element_text(size=15),axis.title=element_text(size=14,face="bold",family="BL"))+
  ggtitle("各時辰案件量分布") +
  labs(x="時間區間(時辰)",y="2007~2012年總案件數量")

colnames(NTP_Data)
```

##各時間區間之報案原因分布
1. 紅框部分為A220因交通事故(受傷機轉)，案件數量在上下班時間明顯比其他時段多，且整體而言其案件數量在各時段皆比其他報案原因多，是新北市緊急救護最大負擔
2. 藍框部分為A090肢體無力，案件量第二多，相對交通事故，肢體無力案件在全天分布較平均
3. 綠框部分為A230非交通事故(受傷機轉)，案件數量第三多，時間分布平均，原因有待研究

![各時間區間之報案原因分布]https://github.com/LeoWongTaiwan/Research-Project/blob/master/%E5%80%8B%E6%99%82%E8%BE%B0%E5%A0%B1%E6%A1%88%E5%8E%9F%E5%9B%A0.png
